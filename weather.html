<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Model Viewer</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 960px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px; box-sizing: border-box; }
        h1 { text-align: center; margin-top: 0; }
        .controls, .info, .animation-controls { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; align-items: center; }
        .control-group { flex: 1; min-width: 150px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; }
        select, button { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #dddfe2; font-size: 16px; }
        button { background-color: #1877f2; color: white; border: none; cursor: pointer; flex-basis: 100%; }
        button:hover { background-color: #166fe5; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .progress-container { width: 100%; background-color: #e9ebee; border-radius: 6px; margin-top: -10px; margin-bottom: 20px; display: none; }
        #progressBar { width: 0%; height: 8px; background-color: #1877f2; border-radius: 6px; transition: width 0.1s linear; }
        .image-container { width: 100%; background-color: #e9ebee; border: 1px solid #dddfe2; min-height: 400px; display: flex; align-items: center; justify-content: center; border-radius: 6px; }
        #weatherImage { max-width: 100%; display: none; }
        .info span { font-weight: 600; margin-right: 20px; }
        .animation-controls { justify-content: space-between; }
        .animation-controls button { flex-basis: auto; width: 80px; }
        #frameSlider { flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Weather Model Viewer</h1>
        <div class="controls">
            <div class="control-group"><label for="modelSelect">Model</label><select id="modelSelect"></select></div>
            <div class="control-group"><label for="runSelect">Model Run</label><select id="runSelect"></select></div>
            <div class="control-group"><label for="paramSelect">Parameter</label><select id="paramSelect"></select></div>
            <div class="control-group"><label for="regionSelect">Region</label><select id="regionSelect"></select></div>
        </div>
        <button id="fetchButton">Fetch Image Sequence</button>
        <div class="progress-container" id="progressContainer">
            <div id="progressBar"></div>
        </div>
        <div class="info">
            <span id="runTimeLabel">Model Run: --</span>
            <span id="forecastHourLabel">Forecast Hour: --</span>
            <span id="validTimeLabel">Valid Time: --</span>
        </div>
        <div class="animation-controls">
            <button id="playButton" disabled>▶ Play</button>
            <button id="prevButton" disabled>&lt; Prev</button>
            <input type="range" id="frameSlider" min="0" max="0" value="0" style="flex-grow: 1;" disabled>
            <button id="nextButton" disabled>Next &gt;</button>
        </div>
        <div class="image-container">
            <img id="weatherImage" alt="Weather model data">
            <span id="statusText">Select parameters and click 'Fetch' to begin.</span>
        </div>
    </div>

    <script>
        const models = { "GFS": "gfs", "NAM": "nam", "HRRR": "hrrr", "ECMWF": "ecmwf_full" };
        const baseUrls = { "gfs": "https://m1o.pivotalweather.com", "nam": "https://m1o.pivotalweather.com", "hrrr": "https://m2o.pivotalweather.com", "ecmwf_full": "https://m1o.pivotalweather.com" };
        const parameters = { "Composite Reflectivity": "refcmp", "Supercell Composite": "scp", "Significant Tornado": "stp", "Surface-Based CAPE": "sbcape", "Most Unstable CAPE": "mucape", "Updraft Helicity (0-3km)": "uh03_max", "Storm Relative Helicity (0-3km)": "srh03", "Surface-500mb Bulk Shear": "bs0500", "Precipitation Type": "prateptype_cat-imp", "24hr Kuchera Snow Accum": "snku_024h-imp", "Snow Depth": "snod-imp", "Surface Temp": "sfct-imp", "2m Dewpoint": "sfctd-imp", "Surface Relative Humidity": "sfcrh", "Mean Sea Level Pressure": "pmsl_mslp", "10m Wind": "10mwind", "24hr Total Precipitation": "qpf_024h-imp", "500mb Height & Vorticity": "500hv" };
        const regions = { "Continental US": "conus", "Northeast US": "us_ne", "Southeast US": "us_se", "Midwest US": "us_mw", "South Central US": "us_sc", "North Central US": "us_nc", "Southwest US": "us_sw", "West Coast US": "us_wn", "Pacific Northwest": "us_pnw", "North America": "n_america", "Canada": "canada", "Alaska": "alaska", "Europe": "europe" };

        let imageURLs = [];
        let currentFrameIndex = 0;
        let isPlaying = false;
        let animationInterval = null;

        const modelSelect = document.getElementById('modelSelect'), runSelect = document.getElementById('runSelect'), paramSelect = document.getElementById('paramSelect'), regionSelect = document.getElementById('regionSelect'), fetchButton = document.getElementById('fetchButton'), weatherImage = document.getElementById('weatherImage'), statusText = document.getElementById('statusText'), runTimeLabel = document.getElementById('runTimeLabel'), forecastHourLabel = document.getElementById('forecastHourLabel'), validTimeLabel = document.getElementById('validTimeLabel'), playButton = document.getElementById('playButton'), prevButton = document.getElementById('prevButton'), nextButton = document.getElementById('nextButton'), frameSlider = document.getElementById('frameSlider'), progressContainer = document.getElementById('progressContainer'), progressBar = document.getElementById('progressBar');

        function populateSelect(selectElement, dataObject) { for (const key in dataObject) { const option = document.createElement('option'); option.value = dataObject[key]; option.textContent = key; selectElement.appendChild(option); } }
        function generateRunTimes() { const now = new Date(); for (let i = 0; i < 8; i++) { const dt = new Date(now.getTime() - (i * 6 * 60 * 60 * 1000)); const runHour = Math.floor(dt.getUTCHours() / 6) * 6; dt.setUTCHours(runHour, 0, 0, 0); const displayText = `${dt.getUTCFullYear()}-${String(dt.getUTCMonth() + 1).padStart(2, '0')}-${String(dt.getUTCDate()).padStart(2, '0')} ${String(dt.getUTCHours()).padStart(2, '0')}Z` + (i === 0 ? ' (Latest)' : ''); const valueText = `${dt.getUTCFullYear()}${String(dt.getUTCMonth() + 1).padStart(2, '0')}${String(dt.getUTCDate()).padStart(2, '0')}${String(dt.getUTCHours()).padStart(2, '0')}`; runSelect.innerHTML += `<option value="${valueText}">${displayText}</option>`; } }
        function generateForecastHours(modelCode) { if (modelCode === 'gfs' || modelCode === 'ecmwf_full') { return [...Array(81).keys()].map(i => i * 3).concat([...Array(25).keys()].map(i => 246 + i * 6)); } else if (modelCode === 'nam') { return [...Array(85).keys()]; } else if (modelCode === 'hrrr') { return [...Array(49).keys()]; } return []; }

        async function fetchSequence() {
            fetchButton.disabled = true; fetchButton.textContent = 'Fetching...';
            setAnimationControlsState(false);
            imageURLs = []; // Reset the list
            let firstFrameFound = false;

            statusText.textContent = 'Preparing...'; statusText.style.display = 'block';
            weatherImage.style.display = 'none';
            progressContainer.style.display = 'block'; progressBar.style.width = '0%';

            const modelCode = modelSelect.value, baseUrl = baseUrls[modelCode], runTime = runSelect.value, paramCode = paramSelect.value, regionCode = regionSelect.value;
            const hours = generateForecastHours(modelCode);
            const potentialURLs = hours.map(hour => { const hourStr = String(hour).padStart(3, '0'); return `${baseUrl}/maps/models/${modelCode}/${runTime}/${hourStr}/${paramCode}.${regionCode}.png`; });
            
            let consecutiveFailures = 0;
            for (let i = 0; i < potentialURLs.length; i++) {
                const url = potentialURLs[i];
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    if (response.ok) {
                        consecutiveFailures = 0;
                        imageURLs.push(url); // Add the valid URL
                        
                        // --- LIVE UPDATE LOGIC ---
                        if (!firstFrameFound) {
                            displayFrame(0); // Display the first frame immediately
                            setAnimationControlsState(true); // Enable controls
                            firstFrameFound = true;
                        }
                        frameSlider.max = imageURLs.length - 1; // Update slider range
                    } else { consecutiveFailures++; }
                } catch (error) { console.error("Network error:", error); consecutiveFailures++; }
                
                // --- LIVE PROGRESS UPDATE ---
                const progressPercent = Math.round((i + 1) / potentialURLs.length * 100);
                progressBar.style.width = `${progressPercent}%`;
                statusText.textContent = `Verifying Frame ${i + 1} of ${potentialURLs.length}... (${imageURLs.length} found)`;
                
                // Give the browser a moment to breathe and update the UI
                if (i % 5 === 0) { await new Promise(resolve => setTimeout(resolve, 0)); }
                if (consecutiveFailures >= 3) { console.log("Stopping early."); break; }
            }

            if (!firstFrameFound) {
                statusText.textContent = 'Could not find any valid images for this model run and parameter.';
                progressContainer.style.display = 'none';
            } else {
                statusText.style.display = 'none';
            }
            fetchButton.disabled = false; fetchButton.textContent = 'Fetch Image Sequence';
        }

        function displayFrame(index) {
            if (index < 0 || index >= imageURLs.length) return;
            currentFrameIndex = index; frameSlider.value = index; statusText.style.display = 'none'; weatherImage.style.display = 'block';
            weatherImage.src = imageURLs[index];
            const url = imageURLs[index]; const parts = url.split('/'); const runTime = parts[7]; const hourStr = parts[8];
            const year = parseInt(runTime.substring(0, 4)), month = parseInt(runTime.substring(4, 6)) - 1, day = parseInt(runTime.substring(6, 8)), hour = parseInt(runTime.substring(8, 10));
            const runDate = new Date(Date.UTC(year, month, day, hour)); const validDate = new Date(runDate.getTime() + parseInt(hourStr) * 60 * 60 * 1000);
            runTimeLabel.textContent = `Model Run: ${runDate.toISOString().replace('T', ' ').substring(0, 16)}Z`;
            forecastHourLabel.textContent = `Forecast Hour: F${hourStr}`;
            validTimeLabel.textContent = `Valid Time: ${validDate.toISOString().replace('T', ' ').substring(0, 16)}Z`;
        }
        
        function setAnimationControlsState(enabled) { playButton.disabled = !enabled; prevButton.disabled = !enabled; nextButton.disabled = !enabled; frameSlider.disabled = !enabled; }
        function nextFrame() { if (imageURLs.length === 0) return; let newIndex = (currentFrameIndex + 1) % imageURLs.length; displayFrame(newIndex); }
        function prevFrame() { if (imageURLs.length === 0) return; let newIndex = (currentFrameIndex - 1 + imageURLs.length) % imageURLs.length; displayFrame(newIndex); }
        function togglePlay() {
            if (isPlaying) { clearInterval(animationInterval); playButton.textContent = '▶ Play'; } 
            else { animationInterval = setInterval(nextFrame, 200); playButton.textContent = '❚❚ Pause'; }
            isPlaying = !isPlaying;
        }

        window.onload = () => {
            populateSelect(modelSelect, models); populateSelect(paramSelect, parameters); populateSelect(regionSelect, regions); generateRunTimes();
            fetchButton.addEventListener('click', fetchSequence);
            prevButton.addEventListener('click', prevFrame); nextButton.addEventListener('click', nextFrame); playButton.addEventListener('click', togglePlay);
            frameSlider.addEventListener('input', (e) => displayFrame(parseInt(e.target.value)));
        };
    </script>
</body>
</html>
